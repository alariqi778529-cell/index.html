<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø³Ø§Ø­ØªÙ†Ø§ Ø§Ù„Ø®Ø§ØµØ© â¤ï¸</title>
    <script src='https://cdn.scaledrone.com/scaledrone.min.js'></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; margin: 0; height: 100vh; display: flex; flex-direction: column; }
        #lock { position: fixed; inset: 0; background: #1a1a1a; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .header { background: #ff4b2b; padding: 15px; text-align: center; font-weight: bold; }
        #chat { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 12px; border-radius: 15px; max-width: 80%; word-wrap: break-word; }
        .sent { align-self: flex-end; background: #ff4b2b; }
        .rcvd { align-self: flex-start; background: #333; }
        .input-area { padding: 15px; background: #1e1e1e; display: flex; gap: 8px; border-top: 1px solid #333; }
        input { flex: 1; padding: 12px; border-radius: 25px; border: none; background: #333; color: white; outline: none; text-align: center; }
        .btn { background: #ff4b2b; color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; }
    </style>
</head>
<body>

<div id="lock">
    <h2>ğŸ”’ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ</h2>
    <input type="password" id="pass" placeholder="7777">
    <br>
    <button class="btn" onclick="unlock()">Ø¯Ø®ÙˆÙ„</button>
</div>

<div class="header">â¤ï¸ Ù…Ø³Ø§Ø­ØªÙ†Ø§ Ø§Ù„Ø®Ø§ØµØ© â¤ï¸</div>
<div id="chat"></div>

<div id="mainChat" class="input-area" style="display: none;">
    <input type="text" id="text" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§...">
    <button class="btn" onclick="send()">Ø¥Ø±Ø³Ø§Ù„</button>
</div>

<script>
const PASS = "7777";
const LIMIT = 24 * 60 * 60 * 1000;
// Ù‚Ù†Ø§Ø© Ø±Ø¨Ø· Ù…Ø¬Ø§Ù†ÙŠØ© Ø¬Ø§Ù‡Ø²Ø©
const drone = new Scaledrone('cia8X89Fk6Yv0G6C'); 
const roomName = 'observable-our-room';
let room;

function unlock() {
    if(document.getElementById('pass').value === PASS) {
        document.getElementById('lock').style.display='none';
        document.getElementById('mainChat').style.display='flex';
        loadLocalHistory(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù…Ù† Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù‡Ø§ØªÙ
    } else { alert("Ø®Ø·Ø£!"); }
}

drone.on('open', error => {
    if (error) return console.error(error);
    room = drone.subscribe(roomName);
    room.on('data', (data) => {
        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø£ÙŠ Ù…ØªØµÙØ­
        renderMsg(data.text, data.sender === drone.clientId ? 'sent' : 'rcvd', data.time);
    });
});

function send() {
    const input = document.getElementById('text');
    const txt = input.value.trim();
    if(txt && room) {
        drone.publish({
            room: roomName,
            message: { text: txt, sender: drone.clientId, time: Date.now() }
        });
        input.value = '';
    }
}

function renderMsg(text, type, time) {
    const chat = document.getElementById('chat');
    const d = document.createElement('div');
    d.className = 'msg ' + type;
    d.innerText = text;
    chat.appendChild(d);
    chat.scrollTop = chat.scrollHeight;

    // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„Ù„Ù€ 24 Ø³Ø§Ø¹Ø©
    if(type === 'sent' || type === 'rcvd') {
        saveLocal(text, type, time);
    }
}

function saveLocal(t, s, tm) {
    let logs = JSON.parse(localStorage.getItem('chat_final') || '[]');
    if(!logs.find(m => m.tm === tm)) {
        logs.push({t, s, tm});
        localStorage.setItem('chat_final', JSON.stringify(logs));
    }
}

function loadLocalHistory() {
    const now = Date.now();
    let logs = JSON.parse(localStorage.getItem('chat_final') || '[]');
    const filtered = logs.filter(m => (now - m.tm) < LIMIT);
    localStorage.setItem('chat_final', JSON.stringify(filtered));
    filtered.forEach(m => renderMsg(m.t, m.s, m.tm));
}

document.getElementById('text').addEventListener('keypress', (e) => { if(e.key === 'Enter') send(); });
</script>
</body>
</html>
