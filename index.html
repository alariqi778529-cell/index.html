<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø³Ø§Ø­ØªÙ†Ø§ Ø§Ù„Ø®Ø§ØµØ© â¤ï¸</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; margin: 0; height: 100vh; display: flex; flex-direction: column; }
        #lock { position: fixed; inset: 0; background: #1a1a1a; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .header { background: #ff4b2b; padding: 15px; text-align: center; font-weight: bold; font-size: 1.2rem; }
        #chat { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 12px 18px; border-radius: 20px; max-width: 80%; word-wrap: break-word; font-size: 0.95rem; line-height: 1.4; }
        .sent { align-self: flex-end; background: #ff4b2b; color: white; border-bottom-right-radius: 2px; }
        .rcvd { align-self: flex-start; background: #333; color: white; border-bottom-left-radius: 2px; }
        .input-area { padding: 15px; background: #1e1e1e; display: flex; gap: 8px; border-top: 1px solid #333; }
        #setup { padding: 20px; text-align: center; background: #1a1a1a; }
        input { flex: 1; padding: 12px; border-radius: 25px; border: 1px solid #444; background: #333; color: white; outline: none; text-align: center; }
        .btn { background: #ff4b2b; color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: bold; }
        .system-msg { align-self: center; font-size: 0.8rem; color: #888; margin: 5px 0; }
    </style>
</head>
<body>

<div id="lock">
    <h2>ğŸ”’ Ù…Ø³Ø§Ø­Ø© Ø®Ø§ØµØ©</h2>
    <p>Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„Ø¯Ø®ÙˆÙ„</p>
    <input type="password" id="pass" placeholder="Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ">
    <br>
    <button class="btn" onclick="unlock()">Ø¯Ø®ÙˆÙ„</button>
</div>

<div class="header">â¤ï¸ Ù…Ø³Ø§Ø­ØªÙ†Ø§ Ø§Ù„Ø®Ø§ØµØ© â¤ï¸</div>

<div id="setup">
    <p>Ø§Ø¯Ø®Ù„Ø§ Ù†ÙØ³ "Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©" Ù„Ù„Ø§Ø±ØªØ¨Ø§Ø·</p>
    <input type="text" id="room" placeholder="Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ© (Ù…Ø«Ù„Ø§Ù‹: secret123)">
    <button class="btn" onclick="start()">Ø±Ø¨Ø·</button>
</div>

<div id="chat"></div>

<div id="mainChat" class="input-area" style="display: none;">
    <input type="text" id="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§...">
    <button class="btn" onclick="send()">Ø¥Ø±Ø³Ø§Ù„</button>
</div>

<script>
let p, c;
const SECRET_PASS = "7777";
const ONE_DAY = 24 * 60 * 60 * 1000; // 24 Ø³Ø§Ø¹Ø©

// 1. ÙØªØ­ Ø§Ù„Ù‚ÙÙ„ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
function unlock() {
    if(document.getElementById('pass').value === SECRET_PASS) {
        document.getElementById('lock').style.display = 'none';
        loadHistory();
    } else {
        alert("Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­!");
    }
}

// 2. Ø¨Ø¯Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„
function start() {
    const roomId = "room-" + document.getElementById('room').value;
    if(!document.getElementById('room').value) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ©");

    p = new Peer(roomId);
    
    p.on('open', () => {
        addSystemMsg("ØªÙ… ÙØªØ­ Ø§Ù„ØºØ±ÙØ©. Ø§Ø·Ù„Ø¨ Ù…Ù†Ù‡Ø§ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù….");
    });

    p.on('connection', conn => {
        c = conn;
        setupConnection();
    });

    p.on('error', (err) => {
        if(err.type === 'id-taken') {
            p = new Peer(); 
            p.on('open', () => {
                c = p.connect(roomId);
                setupConnection();
            });
        }
    });
}

function setupConnection() {
    c.on('open', () => {
        addSystemMsg("âœ… Ù…ØªØµÙ„Ø§Ù† Ø§Ù„Ø¢Ù†!");
        document.getElementById('setup').style.display = 'none';
        document.getElementById('mainChat').style.display = 'flex';
    });
    c.on('data', data => addMsg(data, 'rcvd'));
}

// 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
function send() {
    const m = document.getElementById('text').value;
    if(c && m) {
        c.send(m);
        addMsg(m, 'sent');
        document.getElementById('text').value = '';
    }
}

// 4. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ†
function addMsg(text, type, time = Date.now()) {
    const d = document.createElement('div');
    d.className = 'msg ' + type;
    d.innerText = text;
    document.getElementById('chat').appendChild(d);
    document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;

    // Ø­ÙØ¸ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
    saveToLocal(text, type, time);
}

function addSystemMsg(t) {
    const d = document.createElement('div');
    d.className = 'system-msg';
    d.innerText = t;
    document.getElementById('chat').appendChild(d);
}

function saveToLocal(text, sender, timestamp) {
    let history = JSON.parse(localStorage.getItem('private_chat_v1') || '[]');
    history.push({ text, sender, timestamp });
    localStorage.setItem('private_chat_v1', JSON.stringify(history));
}

function loadHistory() {
    const now = Date.now();
    let history = JSON.parse(localStorage.getItem('private_chat_v1') || '[]');
    
    // ØªØµÙÙŠØ© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ø£Ù‚Ù„ Ù…Ù† 24 Ø³Ø§Ø¹Ø©)
    const validHistory = history.filter(m => (now - m.timestamp) < ONE_DAY);
    localStorage.setItem('private_chat_v1', JSON.stringify(validHistory));

    validHistory.forEach(m => {
        const d = document.createElement('div');
        d.className = 'msg ' + m.sender;
        d.innerText = m.text;
        document.getElementById('chat').appendChild(d);
    });
    document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
}

// Ø¯Ø¹Ù… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± Ø²Ø± Enter
document.getElementById('text').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') send();
});
</script>

</body>
</html>
