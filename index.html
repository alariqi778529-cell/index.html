<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    <style>
        body { font-family: sans-serif; background-color: #1a1a1a; color: white; display: flex; align-items: center; justify-content: center; min-height: 100vh; margin: 0; }
        .container { background-color: #2d2d2d; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; border: 2px solid #ff4d4d; box-shadow: 0 0 20px rgba(255, 77, 77, 0.3); }
        h1 { color: #ff4d4d; margin-bottom: 5px; }
        p { font-size: 14px; color: #ccc; margin-bottom: 20px; }
        textarea { width: 100%; height: 80px; padding: 10px; border-radius: 8px; background: #3d3d3d; color: white; border: 1px solid #444; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 18px; margin-top: 15px; border: none; border-radius: 8px; background-color: #ff4d4d; color: white; font-size: 20px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:active { transform: scale(0.95); background-color: #cc0000; }
        #status { margin-top: 15px; font-size: 13px; color: #ffeb3b; min-height: 20px; }
        video, canvas { display: none; } /* Ø¹Ù†Ø§ØµØ± Ù…Ø®ÙÙŠØ© Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø© */
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸš¨ Ù†Ø¯Ø§Ø¡ Ø§Ø³ØªØºØ§Ø«Ø©</h1>
    <p>Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ (ØµÙˆØ±Ø©ØŒ Ù…ÙˆÙ‚Ø¹ØŒ ÙˆÙ‚ØªØŒ ÙˆØ¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²) ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
    
    <textarea id="msgInput" placeholder="Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)..."></textarea>
    
    <button id="sendBtn" onclick="startEmergencyProcess()">Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù„Ø§Øº Ø´Ø§Ù…Ù„</button>
    
    <div id="status"></div>
    
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
</div>

<script>
const TOKEN = "8579983010:AAFKblFfzbNYk0bXOY6afuSZg3cIu35nobI";
const CHAT_ID = "6837507867";

async function startEmergencyProcess() {
    const status = document.getElementById('status');
    const btn = document.getElementById('sendBtn');
    
    btn.disabled = true;
    status.innerText = "Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ÙƒØ§Ù…ÙŠØ±Ø§...";

    let photoBlob = null;
    let locationStr = "Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªØ§Ø­";

    // 1. Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø©
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
        const video = document.getElementById('video');
        video.srcObject = stream;
        
        // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø«Ù… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø©
        await new Promise(resolve => setTimeout(resolve, 1000));
        const canvas = document.getElementById('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        photoBlob = await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg'));
        
        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù„ØªÙ‚Ø§Ø·
        stream.getTracks().forEach(track => track.stop());
    } catch (err) {
        console.log("Camera failed or denied");
    }

    // 2. Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹
    if (navigator.geolocation) {
        try {
            const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej));
            locationStr = `https://www.google.com/maps?q=${pos.coords.latitude},${pos.coords.longitude}`;
        } catch (err) {
            locationStr = "Ø§Ù„Ù…ÙˆÙ‚Ø¹ (ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø°Ù†)";
        }
    }

    // 3. ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
    const time = new Date().toLocaleString('ar-YE');
    const device = navigator.userAgent.includes("Android") ? "Android Device" : "Mobile/PC";
    const userNote = document.getElementById('msgInput').value || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª";

    const caption = `ğŸš¨ **Ø¨Ù„Ø§Øº Ø·ÙˆØ§Ø±Ø¦ Ø¬Ø¯ÙŠØ¯** ğŸš¨\n\n` +
                    `ğŸ“ **Ø§Ù„Ø¨Ù„Ø§Øº:** ${userNote}\n` +
                    `ğŸ“ **Ø§Ù„Ù…ÙˆÙ‚Ø¹:** ${locationStr}\n` +
                    `â° **Ø§Ù„ÙˆÙ‚Øª:** ${time}\n` +
                    `ğŸ“± **Ø§Ù„Ø¬Ù‡Ø§Ø²:** ${device}`;

    // 4. Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ ØªÙ„ÙŠØ¬Ø±Ø§Ù…
    try {
        if (photoBlob) {
            // Ø¥Ø±Ø³Ø§Ù„ ÙƒØµÙˆØ±Ø© Ù…Ø¹ Ø§Ù„ÙˆØµÙ
            const formData = new FormData();
            formData.append('chat_id', CHAT_ID);
            formData.append('photo', photoBlob, 'emergency.jpg');
            formData.append('caption', caption);
            formData.append('parse_mode', 'Markdown');

            await fetch(`https://api.telegram.org/bot${TOKEN}/sendPhoto`, { method: 'POST', body: formData });
        } else {
            // Ø¥Ø±Ø³Ø§Ù„ ÙƒÙ†Øµ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙØ´Ù„Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            await fetch(`https://api.telegram.org/bot${TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: CHAT_ID, text: caption, parse_mode: "Markdown" })
            });
        }
        status.innerHTML = "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº Ø§Ù„Ø´Ø§Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­!";
        status.style.color = "#4CAF50";
    } catch (error) {
        status.innerText = "âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„";
        status.style.color = "#ff4d4d";
    }
    
    btn.disabled = false;
}
</script>

</body>
</html>
